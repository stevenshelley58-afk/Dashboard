Data Pipeline Specification

Single source of truth for ELT from raw ingest to reporting views. Defines schemas, data flow, and transformation rules.

1) Overall Data Flow

ELT model.

Extract & Load: apps/worker on Railway runs on a schedule. It pulls raw data (e.g., Shopify JSONL via Bulk Operations) and loads into staging_ingest. Shopify allows only one bulk operation of each type per shop at a time. 
Shopify
+1

Transform: Worker runs SQL transforms in-DB. It cleans, types, and upserts into core_warehouse.

Present: reporting exposes read-only views on top of core_warehouse for the Next.js frontend. If the app reads via Supabase REST, ensure the schema/tables are exposed in API settings.

2) Version Control (Git)

Monorepo with apps/ and supabase/.

Branching: main → develop → feature/*.

Deploys: main → production on Vercel and Railway. develop or PRs → preview.

DB migrations are not auto-run on deploy. Apply intentionally via supabase link then supabase db push.

3) Technology Stack and Tooling
Components
Component	Tool / Platform	Purpose and notes
Frontend (apps/web)	Vercel + Next.js	Hosts the app. Vercel ↔ Supabase integration can auto-sync NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. Server-side secrets remain private. 
Vercel
+1

Worker (apps/worker)	Railway	Long-running background worker. Connects to Supabase via SUPABASE_DB_URL with TLS (?sslmode=require). Use pooler strings when appropriate. Transaction-mode pooler is ideal for serverless. Session mode suits long-lived workers. 
Supabase
+1

DB, Auth, Edge	Supabase	Supabase CLI: supabase start, supabase migration new, supabase db push, supabase functions deploy, supabase secrets set. Edge Functions verify JWT by default; per-function override via supabase/config.toml verify_jwt = false if you must accept unauthenticated calls. 
Supabase
+1
Development tools
Tool	Purpose	Notes
Vercel CLI	Deploy, link, env, logs, DNS	Windows supported
Supabase CLI	Local stack, migrations, functions, secrets, pushes	Primary backend CLI
Railway CLI	Manage worker service, logs, cron	Integrates with GitHub deploys
Git CLI	Version control	Standard workflow
GitHub CLI	PRs, releases, repo ops	Optional
Chrome DevTools	Inspect requests and UI behavior	Required for frontend and API validation

Integrations

Vercel ↔ Supabase keeps required env vars synchronized for web. 
Vercel

Railway ↔ GitHub automates worker builds and deploys.

Edge Functions injected vars: Supabase injects predefined vars, including SUPABASE_DB_URL and service keys; add only your custom secrets. 
Supabase
+2
GitHub
+2

4) Schema Definitions
Schema	Purpose	R/W access
staging_ingest	Raw, temporary. Drop or truncate is acceptable.	Worker: R/W
core_warehouse	Clean, typed, relational source of truth.	Worker: R/W
reporting	Read-optimized views. Expose via API settings if the app reads via REST.	Worker: R/W to refresh • Frontend: Read-only
app_dashboard	App tables, e.g., user prefs and saved reports.	Frontend: R/W
5) Pipeline Job Types

Worker polls core_warehouse.etl_runs for queued jobs. External triggers insert rows.

Job type	Trigger	Description
Historical backfill	Manual “Sync” inserts QUEUED	Pulls all historical source data once per shop
Incremental sync	Scheduled or manual	Pulls since last success in core_warehouse.sync_cursors

On success: update cursor and counts. On failure: do not advance cursor; mark etl_runs failed with error payload.

6) Core Transforms (Shopify)

GraphQL Admin API with Bulk Operations for backfills. Auth with SHOPIFY_ADMIN_ACCESS_TOKEN and fixed SHOPIFY_API_VERSION. One bulk operation of each type per shop at a time. 
Shopify
+1

Source (staging)	Target (warehouse)	Idempotency
staging_ingest.shopify_shops_raw	core_warehouse.shops	ON CONFLICT (shop_id) DO UPDATE
staging_ingest.shopify_orders_raw	core_warehouse.orders	ON CONFLICT (shop_id, shopify_gid) DO UPDATE
staging_ingest.shopify_line_items_raw	core_warehouse.order_line_items	ON CONFLICT (shop_id, shopify_gid) DO UPDATE
staging_ingest.shopify_transactions_raw	core_warehouse.transactions	ON CONFLICT (shop_id, shopify_gid) DO UPDATE
staging_ingest.shopify_payouts_raw	core_warehouse.payouts	ON CONFLICT (shop_id, shopify_gid) DO UPDATE
7) Marketing Transforms

Meta requires META_AD_ACCOUNT_ID and a long-lived Business System User token. GA4 requires a Service Account with GA4 property access and the Data API enabled. Klaviyo uses Authorization: Klaviyo-API-Key <key>. Normalize to (shop_id, date) and a canonical currency and timezone for correct MER and ROAS joins. 
Supabase

Source (staging)	Target (warehouse)	Idempotency
staging_ingest.meta_insights_raw	core_warehouse.fact_marketing_daily	ON CONFLICT (shop_id, date, platform)
staging_ingest.ga4_report_raw	core_warehouse.fact_ga4_daily	ON CONFLICT (shop_id, date)
staging_ingest.klaviyo_metrics_raw	core_warehouse.fact_email_daily	ON CONFLICT (shop_id, date)
8) Reporting Layer (Views)

Start as VIEW. Promote to MATERIALIZED VIEW if needed. Expose reporting to the API if the frontend uses Supabase REST.

View	Sources	Purpose
reporting.sync_status	etl_runs, shops	UI status for current and past syncs
reporting.daily_revenue	orders, transactions	Daily revenue, orders, AOV
reporting.orders_daily	orders	Daily order counts
reporting.cash_to_bank	payouts, transactions	Payout status and cash flow
reporting.mer_roas	fact_marketing_daily, daily_revenue	MER and ROAS with currency normalization
Environment contract applied

Use only: SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY, SUPABASE_DB_URL, SUPABASE_JWT_SECRET. Edge Functions receive these automatically; add only custom secrets. 
Supabase
+1

Frontend uses NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY via the Vercel ↔ Supabase integration. 
Vercel

Worker connects via SUPABASE_DB_URL with TLS. Use pooler strings where appropriate. Transaction mode for serverless, session mode for long-lived processes. 
Supabase
+1

Edge Functions require Authorization: Bearer <JWT> by default. Disable per function with verify_jwt = false in supabase/config.toml only if you implement your own checks. 
Supabase
+1

Dashboard .env Contract

Authoritative list. Keep names identical across Supabase, Vercel, and Railway. Placeholders shown.

1) Supabase Project

Supabase → Project → Settings → API → Config

SUPABASE_URL="https://<project-ref>.supabase.co"
SUPABASE_ANON_KEY="<public-anon-key>"
SUPABASE_SERVICE_ROLE_KEY="<service-role-key>"
SUPABASE_DB_URL="postgresql://postgres.<region>.supabase.co:5432/postgres?sslmode=require"
SUPABASE_JWT_SECRET="<project-jwt-secret>"


Edge Functions automatically receive these. Do not redeclare them in function secrets. 
Supabase
+1

2) Vercel (Frontend)

Vercel → Project → Settings → Environment Variables

NEXT_PUBLIC_SUPABASE_URL="${SUPABASE_URL}"
NEXT_PUBLIC_SUPABASE_ANON_KEY="${SUPABASE_ANON_KEY}"


Public vars must start with NEXT_PUBLIC_. Use the Vercel ↔ Supabase integration to sync. 
Vercel

3) Railway (Worker / Backend Service)

Railway → Service → Variables

# Core database + Supabase connection
SUPABASE_URL="${SUPABASE_URL}"
SUPABASE_SERVICE_ROLE_KEY="${SUPABASE_SERVICE_ROLE_KEY}"
SUPABASE_DB_URL="${SUPABASE_DB_URL}"
SUPABASE_JWT_SECRET="${SUPABASE_JWT_SECRET}"

# Shopify
SHOPIFY_ADMIN_ACCESS_TOKEN="<admin-access-token>"
SHOPIFY_SHOP_DOMAIN="my-store.myshopify.com"
SHOPIFY_API_VERSION="2025-01"

# Meta
META_ACCESS_TOKEN="<business-system-user-token>"
META_AD_ACCOUNT_ID="act_1234567890"

# Google Analytics 4
GA4_PROPERTY_ID="<ga4-property-id>"
GA4_CREDENTIALS_JSON='<service-account-json>'

# Klaviyo
KLAVIYO_API_KEY="<private-api-key>"


Cron jobs should connect, run, and exit cleanly.

4) Local Development (.env.local)

For Cursor or local CLI testing.

SUPABASE_URL="https://<project-ref>.supabase.co"
SUPABASE_ANON_KEY="<public-anon-key>"
SUPABASE_SERVICE_ROLE_KEY="<service-role-key>"
SUPABASE_DB_URL="postgresql://postgres.<region>.supabase.co:5432/postgres?sslmode=require"
SUPABASE_JWT_SECRET="<project-jwt-secret>"

SHOPIFY_ADMIN_ACCESS_TOKEN="<admin-access-token>"
SHOPIFY_SHOP_DOMAIN="my-store.myshopify.com"
SHOPIFY_API_VERSION="2025-01"

META_ACCESS_TOKEN="<business-system-user-token>"
META_AD_ACCOUNT_ID="act_1234567890"

GA4_PROPERTY_ID="<ga4-property-id>"
GA4_CREDENTIALS_JSON='<service-account-json>'

KLAVIYO_API_KEY="<private-api-key>"

API and Job Lifecycle Contract

Authoritative states, the /sync API, and shared payloads. Types live in packages/config.

1) Job lifecycle enums

RunStatus
QUEUED. IN_PROGRESS. SUCCEEDED. FAILED. PARTIAL.

JobType
HISTORICAL. INCREMENTAL.

Platform
SHOPIFY. META. GA4. KLAVIYO.

2) API: /functions/v1/sync

Edge Function that enqueues an ETL run. Fast and side-effect minimal.

Method: POST /functions/v1/sync

Auth: Authorization: Bearer <Supabase Auth access token>. JWT verification enabled by default. Do not send the service role key as a token. If you need unauthenticated access, disable verification per function and enforce your own checks. 
Supabase
+1

Latency target: sub-1 s.

Behavior: validate caller’s access to shop_id, insert QUEUED row in core_warehouse.etl_runs, return run_id. A scheduled worker picks it up.

Request body

{ "shop_id": "sh_123abc", "job_type": "INCREMENTAL", "platform": "SHOPIFY" }


Responses

202 Accepted → { "run_id": "run_9a8b7c" }

400 Bad Request → invalid job_type

401/403 → not authenticated or no access

3) Glue table: core_warehouse.etl_runs
Column	Type	Notes
id	uuid PK	gen_random_uuid(); returned as run_id
shop_id	text	Indexed
status	text	RunStatus
job_type	text	JobType
platform	text	Platform
error	jsonb	ErrorPayload on FAILED or PARTIAL
records_synced	integer	Primary entity count
created_at	timestamptz	default now()
started_at	timestamptz	set on claim
completed_at	timestamptz	terminal states

Operational notes
Worker polls QUEUED, sets IN_PROGRESS, runs, then sets SUCCEEDED or FAILED. Do not advance cursors on failure. Railway cron starts the worker on a crontab schedule; jobs finish and exit cleanly.

Optional guard
Partial unique index to prevent duplicate in-flight jobs per (shop_id, platform) for QUEUED or IN_PROGRESS.

4) ErrorPayload shape
{
  "code": "SHOPIFY_AUTH_ERROR",
  "message": "Invalid Shopify access token.",
  "service": "apps/worker",
  "task": "shopify_client_init",
  "stack_trace": "..."
}


Suggested codes:
SHOPIFY_AUTH_ERROR, SHOPIFY_RATE_LIMIT, SHOPIFY_BULK_NOT_READY.
META_AUTH_ERROR, META_RATE_LIMIT.
GA4_PERMISSION_DENIED.
KLAVIYO_AUTH_ERROR.
DB_WRITE_ERROR, SCHEMA_MISMATCH, UNKNOWN.